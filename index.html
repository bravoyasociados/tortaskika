<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta Pro - Impresi√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --accent: #25d366; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .product-card { border: none; border-radius: 12px; transition: 0.2s; cursor: pointer; background: white; height: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-prod { height: 110px; width: 100%; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .cart-container { background: white; border-radius: 15px; padding: 15px; position: sticky; top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-logo { max-height: 40px; margin-right: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark sticky-top shadow-sm">
    <div class="container-fluid d-flex flex-column flex-sm-row">
        <a class="navbar-brand fw-bold mb-2 mb-sm-0" id="nav-logo-container">
            <img src="logot.png" class="nav-logo" onerror="this.style.display='none'"> Mi Negocio
        </a>
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active text-white" data-bs-toggle="pill" data-bs-target="#vta">Ventas</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="pill" data-bs-target="#inv">Inventario</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="pill" data-bs-target="#box" onclick="renderCorte()">Corte</button></li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="vta">
            <div class="row">
                <div class="col-lg-8">
                    <input type="text" id="bus" class="form-control mb-3 p-3 shadow-sm" placeholder="üîç Buscar producto..." onkeyup="renderVentas()">
                    <div class="row row-cols-2 row-cols-md-3 g-3" id="grid-ventas"></div>
                </div>
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="cart-container shadow border-0 text-center">
                        <h5 class="fw-bold mb-3">üõí Orden Actual</h5>
                        <div id="items-carrito" class="my-3 text-start" style="max-height: 300px; overflow-y: auto;"></div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <span class="h4 mb-0">Total:</span>
                            <span id="total-vta" class="h4 mb-0 text-success fw-bold">$0.00</span>
                        </div>
                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-success py-3 fw-bold shadow-sm" onclick="finalizarVenta(true)">üì± COBRAR Y WHATSAPP</button>
                            <button class="btn btn-outline-dark py-2 fw-bold" onclick="finalizarVenta(false)">üñ®Ô∏è IMPRIMIR TICKET</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="inv">
            <div class="row">
                <div class="col-md-5">
                    <div class="card p-4 shadow-sm border-0 mb-4">
                        <h5 id="form-title">Gestionar Producto</h5>
                        <input type="hidden" id="edit-id"><input type="text" id="n-nom" class="form-control mb-2" placeholder="Nombre">
                        <input type="number" id="n-pre" class="form-control mb-2" placeholder="Precio $">
                        <input type="file" id="n-img" class="form-control mb-3" accept="image/*">
                        <button class="btn btn-primary w-100 mb-2" onclick="guardarProducto()">Guardar Cambios</button>
                        <button class="btn btn-secondary w-100" onclick="limpiarForm()">Cancelar</button>
                    </div>
                </div>
                <div class="col-md-7"><div class="card p-3 border-0 shadow-sm overflow-auto"><table class="table align-middle"><thead><tr><th>Img</th><th>Producto</th><th>Precio</th><th>Acciones</th></tr></thead><tbody id="tabla-prod"></tbody></table></div></div>
            </div>
        </div>

        <div class="tab-pane fade" id="box">
            <div class="card p-4 shadow-sm border-0 bg-white">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h3 class="mb-0">üìä Corte de Caja</h3>
                    <button class="btn btn-dark fw-bold" onclick="imprimirCorte()">üñ®Ô∏è IMPRIMIR CORTE PDF</button>
                </div>
                <div class="row g-3 mb-4 text-center">
                    <div class="col-6"><div class="p-3 border rounded bg-light"><h6>Ventas Totales</h6><h2 class="text-success" id="c-tot">$0.00</h2></div></div>
                    <div class="col-6"><div class="p-3 border rounded bg-light"><h6>Art√≠culos</h6><h2 id="c-qty">0</h2></div></div>
                </div>
                <div id="c-detalles" class="list-group mb-4 shadow-sm"></div>
                <button class="btn btn-outline-danger btn-sm w-100" onclick="limpiarCorte()">Reiniciar Ventas del D√≠a</button>
            </div>
        </div>
    </div>
</div>

<script>
    let productos = JSON.parse(localStorage.getItem('p_data')) || [{ id: 1, nom: "Ejemplo", pre: 10, img: "https://via.placeholder.com/150" }];
    let ventas = JSON.parse(localStorage.getItem('v_data')) || [];
    let carrito = {};

    function modCar(id, delta) {
        const p = productos.find(x => x.id == id);
        if(!carrito[id]) carrito[id] = { nom: p.nom, pre: p.pre, qty: 0 };
        carrito[id].qty += delta;
        if(carrito[id].qty <= 0) delete carrito[id];
        renderCarrito();
    }

    function renderCarrito() {
        const c = document.getElementById('items-carrito');
        let t = 0; c.innerHTML = '';
        Object.keys(carrito).forEach(id => {
            const i = carrito[id]; t += i.pre * i.qty;
            c.innerHTML += `<div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded border-start border-4 border-success">
                <span><b>${i.qty}</b> x ${i.nom}</span>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-dark" onclick="modCar(${id},-1)">-</button>
                    <button class="btn btn-outline-dark" onclick="modCar(${id},1)">+</button>
                </div>
            </div>`;
        });
        document.getElementById('total-vta').innerText = `$${t.toFixed(2)}`;
    }

    async function finalizarVenta(enviarWhatsapp) {
        if(Object.keys(carrito).length == 0) return alert("Carrito vac√≠o");
        let t = 0; let msg = "*üßæ TICKET DE VENTA*%0A--------------------------%0A";
        Object.keys(carrito).forEach(id => {
            const i = carrito[id]; t += i.pre * i.qty;
            msg += `‚Ä¢ ${i.qty} ${i.nom} - $${(i.pre*i.qty).toFixed(2)}%0A`;
            ventas.push({...i, fecha: new Date().toLocaleString()});
        });
        msg += `--------------------------%0A*TOTAL: $${t.toFixed(2)}*%0A%0A¬°Gracias!`;
        localStorage.setItem('v_data', JSON.stringify(ventas));
        
        await imprimirTicket(t);
        if(enviarWhatsapp) setTimeout(() => window.open(`https://wa.me/?text=${msg}`, '_blank'), 1000);
        carrito = {}; renderCarrito();
    }

    async function cargarLogo() {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = 'logot.png';
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
        });
    }

    async function imprimirTicket(total) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ format: [80, 160] });
        let y = 10;
        const logo = await cargarLogo();
        if(logo) { doc.addImage(logo, 'PNG', 30, y, 20, 20); y += 25; }
        doc.setFontSize(10); doc.text("TICKET DE VENTA", 40, y, {align:'center'});
        y += 10; doc.setFontSize(8); doc.text(new Date().toLocaleString(), 40, y, {align:'center'});
        y += 10;
        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            doc.text(`${i.qty} x ${i.nom}`, 10, y);
            doc.text(`$${(i.pre*i.qty).toFixed(2)}`, 70, y, {align:'right'});
            y += 7;
        });
        doc.line(10, y, 70, y);
        doc.setFontSize(11); doc.text(`TOTAL: $${total.toFixed(2)}`, 70, y+8, {align:'right'});
        doc.autoPrint();
        window.open(doc.output('bloburl'), '_blank');
    }

    async function imprimirCorte() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const logo = await cargarLogo();
        
        if(logo) doc.addImage(logo, 'PNG', 15, 15, 30, 30);
        
        doc.setFontSize(22); doc.setTextColor(40);
        doc.text("REPORTE DE CORTE DE CAJA", 60, 30);
        doc.setFontSize(10); doc.setTextColor(100);
        doc.text(`Fecha y Hora de Emisi√≥n: ${new Date().toLocaleString()}`, 60, 38);
        
        let t = 0; let q = 0; let resumen = {};
        ventas.forEach(v => {
            t += v.pre * v.qty; q += v.qty;
            resumen[v.nom] = (resumen[v.nom] || 0) + v.qty;
        });

        doc.autoTable({
            startY: 55,
            head: [['Concepto', 'Informaci√≥n']],
            body: [['Total en Dinero', `$${t.toFixed(2)}`], ['Total de Art√≠culos Vendidos', q]],
            theme: 'striped', headStyles: { fillColor: [44, 62, 80] }
        });

        let tablaBody = Object.keys(resumen).map(nombre => [nombre, resumen[nombre]]);
        doc.text("Detalle por Producto:", 15, doc.lastAutoTable.finalY + 15);
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 20,
            head: [['Nombre del Producto', 'Unidades Vendidas']],
            body: tablaBody,
            theme: 'grid', headStyles: { fillColor: [39, 174, 96] }
        });

        doc.autoPrint();
        window.open(doc.output('bloburl'), '_blank');
    }

    // Funciones b√°sicas de gesti√≥n
    function renderVentas() {
        const g = document.getElementById('grid-ventas');
        const b = document.getElementById('bus').value.toLowerCase();
        g.innerHTML = '';
        productos.filter(p => p.nom.toLowerCase().includes(b)).forEach(p => {
            g.innerHTML += `<div class="col"><div class="card product-card shadow-sm" onclick="modCar(${p.id},1)">
                <img src="${p.img}" class="img-prod">
                <div class="card-body p-2 text-center"><h6 class="mb-0 small fw-bold">${p.nom}</h6><span class="text-success fw-bold">$${p.pre}</span></div>
            </div></div>`;
        });
    }

    function renderGestion() {
        const t = document.getElementById('tabla-prod'); t.innerHTML = '';
        productos.forEach(p => {
            t.innerHTML += `<tr>
                <td><img src="${p.img}" width="40" height="40" style="object-fit:cover" class="rounded"></td>
                <td><small>${p.nom}</small></td><td><small>$${p.pre}</small></td>
                <td><button class="btn btn-sm btn-outline-primary" onclick="prepararEdicion(${p.id})">‚úé</button>
                <button class="btn btn-sm btn-outline-danger" onclick="eliminarProducto(${p.id})">√ó</button></td>
            </tr>`;
        });
    }

    function renderCorte() {
        let t = 0; let q = 0; let r = {};
        ventas.forEach(v => {
            t += v.pre * v.qty; q += v.qty;
            r[v.nom] = (r[v.nom] || 0) + v.qty;
        });
        document.getElementById('c-tot').innerText = `$${t.toFixed(2)}`;
        document.getElementById('c-qty').innerText = q;
        const d = document.getElementById('c-detalles'); d.innerHTML = '';
        Object.keys(r).forEach(n => {
            d.innerHTML += `<div class="list-group-item d-flex justify-content-between"><span>${n}</span><b>${r[n]}</b></div>`;
        });
    }

    function guardarProducto() {
        const nom = document.getElementById('n-nom').value;
        const pre = document.getElementById('n-pre').value;
        const file = document.getElementById('n-img').files[0];
        const editId = document.getElementById('edit-id').value;
        if(!nom || !pre) return alert("Faltan datos");
        const procesar = (img64) => {
            if(editId) {
                let p = productos.find(x => x.id == editId);
                p.nom = nom; p.pre = parseFloat(pre);
                if(img64) p.img = img64;
            } else {
                productos.push({ id: Date.now(), nom, pre: parseFloat(pre), img: img64 || 'https://via.placeholder.com/150' });
            }
            localStorage.setItem('p_data', JSON.stringify(productos));
            limpiarForm(); renderGestion(); renderVentas();
        };
        if(file) {
            const reader = new FileReader();
            reader.onload = (e) => procesar(e.target.result);
            reader.readAsDataURL(file);
        } else { procesar(null); }
    }

    function prepararEdicion(id) {
        const p = productos.find(x => x.id == id);
        document.getElementById('edit-id').value = p.id;
        document.getElementById('n-nom').value = p.nom;
        document.getElementById('n-pre').value = p.pre;
        document.getElementById('form-title').innerText = "Editando Producto";
    }

    function limpiarForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('n-nom').value = '';
        document.getElementById('n-pre').value = '';
        document.getElementById('form-title').innerText = "Gestionar Producto";
    }

    function eliminarProducto(id) {
        if(confirm("¬øEliminar?")) {
            productos = productos.filter(p => p.id != id);
            localStorage.setItem('p_data', JSON.stringify(productos));
            renderGestion(); renderVentas();
        }
    }

    function limpiarCorte() { if(confirm("¬øBorrar historial?")) { ventas = []; localStorage.setItem('v_data','[]'); renderCorte(); } }

    renderVentas(); renderGestion();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>