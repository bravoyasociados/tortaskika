<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta Pro - Compartir PDF</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --accent: #25d366; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .product-card { border: none; border-radius: 12px; transition: 0.2s; cursor: pointer; background: white; height: 100%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-prod { height: 110px; width: 100%; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px; }
        .cart-container { background: white; border-radius: 15px; padding: 15px; position: sticky; top: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .nav-logo { max-height: 40px; margin-right: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark sticky-top shadow-sm">
    <div class="container-fluid d-flex flex-column flex-sm-row">
        <a class="navbar-brand fw-bold mb-2 mb-sm-0" id="nav-logo-container">
            <img src="logot.png" class="nav-logo" onerror="this.style.display='none'"> Mi Negocio
        </a>
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active text-white" data-bs-toggle="pill" data-bs-target="#vta">Ventas</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="pill" data-bs-target="#inv">Inventario</button></li>
            <li class="nav-item"><button class="nav-link text-white" data-bs-toggle="pill" data-bs-target="#box" onclick="renderCorte()">Corte</button></li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="tab-content">
        <div class="tab-pane fade show active" id="vta">
            <div class="row">
                <div class="col-lg-8">
                    <input type="text" id="bus" class="form-control mb-3 p-3 shadow-sm" placeholder=" Buscar producto..." onkeyup="renderVentas()">
                    <div class="row row-cols-2 row-cols-md-3 g-3" id="grid-ventas"></div>
                </div>
                <div class="col-lg-4 mt-4 mt-lg-0">
                    <div class="cart-container shadow border-0 text-center">
                        <h5 class="fw-bold mb-3"> Orden Actual</h5>
                        <div id="items-carrito" class="my-3 text-start" style="max-height: 300px; overflow-y: auto;"></div>
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <span class="h4 mb-0">Total:</span>
                            <span id="total-vta" class="h4 mb-0 text-success fw-bold">$0.00</span>
                        </div>
                        <div class="mt-3 d-grid gap-2">
                            <button class="btn btn-primary py-3 fw-bold shadow-sm" onclick="procesarVenta()">
                                 COBRAR Y COMPARTIR PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="inv">... (Resto del c贸digo de inventario) ...</div>
        <div class="tab-pane fade" id="box">... (Resto del c贸digo de corte) ...</div>
    </div>
</div>

<script>
    // Configuraci贸n inicial de datos
    let productos = JSON.parse(localStorage.getItem('p_data')) || [];
    let ventas = JSON.parse(localStorage.getItem('v_data')) || [];
    let carrito = {};

    // --- LGICA DE VENTA ---
    async function procesarVenta() {
        if (Object.keys(carrito).length === 0) return alert("Carrito vac铆o");
        
        let total = 0;
        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            total += i.pre * i.qty;
            ventas.push({...i, fecha: new Date().toLocaleString()});
        });
        localStorage.setItem('v_data', JSON.stringify(ventas));

        const pdfBlob = await generarPDFBlob(total, "TICKET DE VENTA");
        await compartirArchivo(pdfBlob, `Ticket_${Date.now()}.pdf`, "Aqu铆 tienes tu ticket de compra.");
        
        carrito = {};
        renderCarrito();
    }

    // --- LGICA DE CORTE ---
    async function imprimirCorte() {
        let totalDinero = 0; let totalArticulos = 0; let resumen = {};
        ventas.forEach(v => {
            totalDinero += v.pre * v.qty; totalArticulos += v.qty;
            resumen[v.nom] = (resumen[v.nom] || 0) + v.qty;
        });

        const pdfBlob = await generarCorteBlob(totalDinero, totalArticulos, resumen);
        await compartirArchivo(pdfBlob, `Corte_${new Date().toLocaleDateString()}.pdf`, "Reporte de corte de caja.");
    }

    // --- FUNCIN PARA COMPARTIR (MEN NATIVO) ---
    async function compartirArchivo(blob, fileName, text) {
        const file = new File([blob], fileName, { type: 'application/pdf' });
        
        // Verificar si el navegador soporta compartir archivos
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: fileName,
                    text: text
                });
            } catch (err) {
                console.error("Error al compartir:", err);
                // Si el usuario cancela o hay error, descargar como respaldo
                descargarRespaldo(blob, fileName);
            }
        } else {
            // Caso: PC o navegadores antiguos
            descargarRespaldo(blob, fileName);
            alert("Tu navegador no soporta compartir directamente. El archivo se ha descargado.");
        }
    }

    function descargarRespaldo(blob, fileName) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
    }

    // --- GENERADORES DE PDF (REFACTORES PARA DEVOLVER BLOB) ---
    async function generarPDFBlob(total, titulo) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ format: [80, 160] });
        let y = 10;

        const logo = await cargarLogo();
        if(logo) { doc.addImage(logo, 'PNG', 10, y, 20, 20); y += 25; }
        
        doc.setFontSize(10); doc.text(titulo, 40, y, {align:'center'});
        y += 10; doc.setFontSize(8); doc.text(new Date().toLocaleString(), 40, y, {align:'center'});
        y += 10;

        Object.keys(carrito).forEach(id => {
            const i = carrito[id];
            doc.text(`${i.qty} x ${i.nom}`, 10, y);
            doc.text(`$${(i.pre*i.qty).toFixed(2)}`, 70, y, {align:'right'});
            y += 7;
        });

        doc.line(10, y, 70, y);
        doc.setFontSize(11); doc.text(`TOTAL: $${total.toFixed(2)}`, 70, y+8, {align:'right'});
        
        return doc.output('blob');
    }

    async function generarCorteBlob(total, cant, resumen) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const logo = await cargarLogo();
        
        if(logo) doc.addImage(logo, 'PNG', 15, 15, 25, 25);
        doc.setFontSize(20); doc.text("REPORTE DE CORTE", 50, 30);
        doc.setFontSize(10); doc.text(`Generado: ${new Date().toLocaleString()}`, 50, 38);

        doc.autoTable({
            startY: 50,
            head: [['Concepto', 'Resultado']],
            body: [['Ventas Totales', `$${total.toFixed(2)}`], ['Art铆culos Vendidos', cant]],
            theme: 'striped', headStyles: { fillColor: [44, 62, 80] }
        });

        const tablaBody = Object.keys(resumen).map(n => [n, resumen[n]]);
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['Producto', 'Vendidos']],
            body: tablaBody,
            theme: 'grid'
        });

        return doc.output('blob');
    }

    async function cargarLogo() {
        return new Promise((resolve) => {
            const img = new Image();
            img.src = 'logot.png';
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
        });
    }

    // (Aqu铆 van las funciones de renderVentas, renderCarrito, renderGestion, etc. del c贸digo anterior)
</script>
</body>
</html>